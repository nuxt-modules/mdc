import{a as y,p as d,c as h,m as v,b as _}from"./pipeline.11fe6584.js";import{aE as b,m as p,a8 as f,ar as C,k as $}from"./entry.3ecf506b.js";import"./_commonjsHelpers.725317a4.js";function m(e){const a=y(e);return async t=>{var n;const o=t.params(),i=await a(t);return o.surround?i.surround:(i.dirConfig&&(i.result={_path:(n=i.dirConfig)==null?void 0:n._path,...i.result,_dir:i.dirConfig}),i.result)}}const I=e=>C(e,p().public.content.api.baseURL),P=d(h({driver:v()}),"@content");function k(e){async function a(){const t=new Set(await e.getKeys("cache:")),o=f().getPreviewToken();if(o){const n=await e.getItem(`${o}$`).then(r=>r||{});if(Array.isArray(n.ignoreSources)){const r=n.ignoreSources.map(c=>`cache:${c.trim()}:`);for(const c of t)r.some(w=>c.startsWith(w))&&t.delete(c)}const s=await e.getKeys(`${o}:`),g=await Promise.all(s.map(r=>e.getItem(r)));for(const r of g)t.delete(`cache:${r._id}`),r.__deleted||t.add(`${o}:${r._id}`)}return await Promise.all(Array.from(t).map(n=>e.getItem(n)))}return{storage:e,fetch:m(a),query:t=>b(m(a),{initialParams:t,legacy:!0})}}let l=null,u=null;async function D(){return u?await u:l||(u=S(),l=await u),l}async function S(){const e=$(),{content:a}=p().public,t=k(P),o=await t.storage.getItem("integrity");if(a.integrity!==+(o||0)){const{contents:i,navigation:n}=await $fetch(I(a.integrity?`cache.${a.integrity}.json`:"cache.json"));await Promise.all(i.map(s=>t.storage.setItem(`cache:${s._id}`,s))),await t.storage.setItem("navigation",n),await t.storage.setItem("integrity",a.integrity)}return await e.callHook("content:storage",t.storage),t}async function B(e){const a=await D();if(!f().getPreviewToken()&&Object.keys(e||{}).length===0)return a.storage.getItem("navigation");const t=await a.query(e).where({_partial:!1,navigation:{$ne:!1}}).find(),i=(await a.query().where({_path:/\/_dir$/i,_partial:!0}).find()).reduce((n,s)=>{var r;((r=s.title)==null?void 0:r.toLowerCase())==="dir"&&(s.title=void 0);const g=s._path.split("/").slice(0,-1).join("/")||"/";return n[g]={...s,...s.body},n},{});return _(t,i)}export{P as contentStorage,k as createDB,B as generateNavigation,D as useContentDatabase};
